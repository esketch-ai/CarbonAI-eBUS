# 00_develop.md - 프로젝트 기술 문서

## 1. 아키텍처 개요

본 프로젝트는 버스 차량의 기본 정보, 운행 기록, 베이스라인 인자, 그리고 CO2 감축량 데이터를 관리하는 시스템입니다. 데이터는 정규화된 PostgreSQL 데이터베이스에 저장되며, 각 처리 단계는 독립적인 Python 스크립트로 구현되어 순차적으로 실행되는 배치 처리 아키텍처를 따릅니다.

## 2. 기술 스택

*   **언어:** Python 3.x
*   **데이터 처리:** Pandas, NumPy
*   **데이터베이스:** PostgreSQL
*   **DB 연결 라이브러리:** Psycopg2
*   **환경 설정:** `db_config.py`를 통한 DB 연결 정보 중앙 관리

## 3. 모듈 및 컴포넌트 설명

*   **`db_config.py`:**
    *   PostgreSQL 데이터베이스 연결에 필요한 호스트, 데이터베이스 이름, 사용자, 비밀번호, 포트 정보를 딕셔너리 형태로 정의합니다. 모든 DB 관련 스크립트에서 이 파일을 임포트하여 일관된 연결 정보를 사용합니다.

*   **`00_edit_db.py`:**
    *   **역할:** 데이터베이스 스키마를 초기화하고 생성합니다.
    *   **주요 기능:**
        *   기존 프로젝트 관련 테이블(bus_vehicle_master, bus_driving_records, bus_monthly_fuel_data, bus_baseline_parameters, bus_emission_reductions)을 모두 삭제합니다.
        *   최신 스키마 정의에 따라 새로운 테이블들을 생성합니다. 이는 개발 환경에서 DB를 초기화하거나 스키마 변경을 적용할 때 유용합니다.

*   **`01_insert_monthly_data.py`:**
    *   **역할:** 가상의 버스 차량 마스터 데이터와 월별 운행 기록 데이터를 생성하고 DB에 적재합니다.
    *   **주요 기능:**
        *   랜덤 데이터를 사용하여 여러 대의 버스에 대한 차량 기본 정보(차량번호, 업체명, 연식, 사업구분, 차대번호 등)를 생성하고 `bus_vehicle_master` 테이블에 삽입/업데이트합니다.
        *   각 차량의 월별 운행 기록(운행일수, 운행거리, 주유량)을 생성하고 `bus_driving_records` 테이블에 삽입/업데이트합니다.
        *   `psycopg2`의 `COPY` 명령을 활용하여 대량의 데이터를 효율적으로 적재합니다.
        *   생성된 데이터를 검토할 수 있도록 `generated_data` 폴더에 엑셀 파일로 저장하는 기능이 포함되어 있습니다.
        *   대체 관계에 있는 차량(내연기관 버스와 이를 대체한 전기 버스)의 정보를 함께 생성하고 연결합니다.

*   **`02_calculate_baseline.py`:**
    *   **역할:** 월별 운행 기록과 차량 마스터 정보를 기반으로 베이스라인 인자를 계산하고 DB에 저장합니다.
    *   **주요 기능:**
        *   `bus_driving_records`와 `bus_vehicle_master` 테이블에서 필요한 데이터를 로드하고 조인합니다.
        *   차량별 연평균 주행거리, 연평균 주유량, km당 연료 사용량(연비) 등의 베이스라인 인자를 계산합니다.
        *   계산된 베이스라인 인자를 `bus_baseline_parameters` 테이블에 삽입/업데이트합니다.

*   **`03_display_baseline.py`:**
    *   **역할:** 계산된 베이스라인 인자를 조회하고 콘솔에 출력합니다.
    *   **주요 기능:**
        *   `bus_baseline_parameters`와 `bus_vehicle_master` 테이블에서 데이터를 로드하고 조인하여 차량 정보와 베이스라인 인자를 함께 표시합니다.
        *   데이터가 없을 경우 사용자에게 안내 메시지를 표시하고, 조회된 데이터를 가독성 좋게 포맷팅하여 출력합니다.

*   **`04_calculate_business_target.py`:**
    *   **역할:** 베이스라인 인자와 차량 마스터 정보를 기반으로 CO2 감축량을 계산하고 DB에 저장합니다.
    *   **주요 기능:**
        *   `bus_baseline_parameters`와 `bus_vehicle_master` 테이블에서 데이터를 로드하고 조인합니다.
        *   정의된 배출 계수를 사용하여 대체 버스(내연기관에서 전기차로 전환)의 CO2 감축량을 계산합니다.
        *   신규 도입 전기 버스에 대한 감축량은 현재 '미산정'으로 처리하며, 향후 유사 내연기관 버스 값을 기반으로 산정할 수 있도록 명시합니다.
        *   계산된 감축량 데이터를 `bus_emission_reductions` 테이블에 삽입/업데이트합니다.

*   **`run_all.py`:**
    *   **역할:** 프로젝트의 모든 스크립트를 순서대로 실행하는 마스터 스크립트(오케스트레이터).
    *   **주요 기능:**
        *   사용자에게 DB 초기화 여부를 확인받아 `00_edit_db.py` 실행 여부를 결정합니다.
        *   `01` -> `02` -> `04` -> `03` 순서로 스크립트를 순차적으로 실행합니다.
        *   스크립트 실행 중 오류가 발생하면 파이프라인을 즉시 중지하고, 표준 출력(stdout)과 표준 에러(stderr)를 모두 출력하여 디버깅을 용이하게 합니다.
        *   `PYTHONIOENCODING=utf-8` 환경 변수를 설정하여 Windows 환경에서의 한글 및 특수문자 인코딩 오류를 방지합니다.

*   **`05_co2_reduction_calc.py`:**
    *   **역할:** 베이스라인 인자와 차량 마스터 정보를 기반으로 상세 CO2 감축량을 계산하고 DB에 저장합니다.
    *   **주요 기능:**
        *   `bus_baseline_parameters`와 `bus_vehicle_master` 테이블에서 데이터를 로드합니다.
        *   전기차의 이용 연수를 계산합니다.
        *   기존 내연기관 차량(경유, CNG)의 연료 유형에 따라 베이스라인 CO2 배출량을 상세 로직으로 계산합니다.
        *   계산된 감축량 데이터를 `bus_emission_reductions` 테이블에 삽입/업데이트합니다.

*   **`06_Report.py`:**
    *   **역할:** 데이터베이스의 모든 관련 테이블을 조인하여 종합 분석 보고서(Excel)를 생성합니다.
    *   **주요 기능:**
        *   `bus_vehicle_master`, `bus_baseline_parameters`, `bus_emission_reductions`, `bus_driving_records` 테이블에서 데이터를 로드합니다.
        *   종합 보고서, 월별 운행기록, 베이스라인 계산결과 세 가지 시트로 구성된 Excel 파일을 생성합니다.
        *   생성된 보고서를 `reports` 폴더에 저장합니다.

*   **`07_calculate_ev_period.py`:**
    *   **역할:** (미구현) 전기차 전환에 따른 감축량 산정 기간 등을 계산하기 위한 스크립트입니다. 현재는 기능이 구현되지 않은 상태입니다.

*   **`constants.py`:**
    *   **역할:** 온실가스 배출량 산정 및 연료 변환에 필요한 상수(순발열량, CO2 배출계수, CNG 밀도 등)를 정의합니다.
    *   **주요 기능:**
        *   경유 및 CNG에 대한 순발열량(`NET_CALORIFIC_VALUE`)을 정의합니다.
        *   경유 및 CNG에 대한 CO2 배출계수(`CO2_EMISSION_FACTOR`)를 정의합니다.
        *   CNG의 밀도(`CNG_DENSITY_KG_PER_M3`)를 정의하여 질량-부피 변환에 사용합니다.

*   **`db_utils.py`:**
    *   **역할:** PostgreSQL 데이터베이스 연결 및 해제를 위한 유틸리티 함수를 제공합니다.
    *   **주요 기능:**
        *   `connect_to_db`: 주어진 파라미터로 데이터베이스에 연결하고 연결 객체를 반환합니다. 연결 실패 시 오류를 처리합니다.
        *   `close_db_connection`: 데이터베이스 연결을 안전하게 닫습니다.
        *   Windows 환경에서 한글 인코딩 문제를 방지하기 위해 `sys.stdout` 및 `sys.stderr`의 인코딩을 `utf-8`로 재설정합니다.

*   **`log_config.py`:**
    *   **역할:** 프로젝트 전반에 걸쳐 사용할 표준 로깅 시스템을 설정합니다.
    *   **주요 기능:**
        *   `logs` 디렉토리를 생성하고, `project.log` 파일에 로그를 기록하도록 설정합니다.
        *   콘솔 및 파일(매일 자정 교체, 7일치 보관)에 로그를 출력하는 핸들러를 구성합니다.
        *   `GHGERC_BUS_PROJECT`라는 이름의 로거 인스턴스를 제공하여 다른 모듈에서 쉽게 로깅 기능을 사용할 수 있도록 합니다.

## 4. 데이터 흐름

1.  **파이프라인 실행:** 사용자가 `run_all.py`를 실행합니다.
2.  **DB 초기화 (선택):** 스크립트가 DB 초기화 여부를 묻고, 사용자가 동의하면 `00_edit_db.py`가 실행되어 모든 관련 테이블을 재생성합니다.
3.  **데이터 생성 및 적재:** `01_insert_monthly_data.py`가 실행되어 가상의 차량 마스터와 월별 운행 기록을 생성하고 DB에 적재합니다.
4.  **베이스라인 계산:** `02_calculate_baseline.py`가 실행되어 월별 운행 기록을 바탕으로 차량별 베이스라인 인자를 계산하고 DB에 저장합니다.
5.  **감축량 계산:** `04_calculate_business_target.py`가 실행되어 계산된 베이스라인을 바탕으로 CO2 감축량을 산정하고 DB에 저장합니다.
6.  **결과 확인:** `03_display_baseline.py`이 실행되어 계산된 베이스라인 결과를 최종적으로 콘솔에 출력합니다.

## 5. API 명세 (내부/외부)

(현재 외부 API는 사용되지 않으며, 내부 스크립트 간의 데이터베이스 인터페이스를 통해 통신합니다.)

## 6. 개발 환경 설정

1.  **Python 설치:** Python 3.x 버전이 설치되어 있어야 합니다.
2.  **PostgreSQL 설치 및 설정:** PostgreSQL 데이터베이스 서버가 실행 중이어야 하며, `db_config.py`에 설정된 정보와 일치하는 데이터베이스, 사용자, 비밀번호가 구성되어 있어야 합니다.
3.  **Python 라이브러리 설치:** 다음 라이브러리를 설치합니다.
    ```bash
pip install pandas numpy psycopg2-binary
    ```
4.  **`db_config.py` 설정:** 프로젝트 루트 디렉토리에 있는 `db_config.py` 파일을 열어 실제 PostgreSQL 연결 정보에 맞게 수정합니다.

## 7. 배포 가이드

(현재는 개발 환경에서의 스크립트 실행을 전제로 하며, 별도의 배포 가이드는 없습니다.)

## 8. 테스트 전략

`run_all.py`를 실행하여 전체 파이프라인의 End-to-End 테스트를 수행합니다. 각 단계의 성공 여부와 최종 결과는 콘솔 출력을 통해 확인하며, 오류 발생 시 `run_all.py`가 제공하는 상세 로그를 통해 원인을 분석합니다. `01_insert_monthly_data.py`가 생성하는 엑셀 파일을 통해 생성된 데이터의 정합성을 검토할 수 있습니다.

## 9. 에러 처리 및 로깅

*   각 스크립트 내에서 `try-except` 블록을 사용하여 데이터베이스 연결 오류, 쿼리 실행 오류, 데이터 적재 오류 등을 처리하고 콘솔에 오류 메시지를 출력합니다.
*   별도의 로깅 시스템은 구현되어 있지 않습니다.

## 10. 보안 고려사항

*   데이터베이스 연결 정보는 `db_config.py` 파일에 별도로 분리하여 관리합니다.
*   현재는 개발 목적으로 평문 비밀번호를 사용하고 있으나, 실제 운영 환경에서는 환경 변수, 비밀 관리 도구 등을 사용하여 보안을 강화해야 합니다.
