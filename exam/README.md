# 버스 CO2 감축량 산정 자동화 파이프라인

## 1. 프로젝트 개요

본 프로젝트는 버스 운행 기록 데이터를 기반으로 내연기관(ICE) 버스를 전기(EV) 버스로 전환했을 때 발생하는 이산화탄소(CO2) 감축량을 자동으로 계산하고 리포트를 생성하는 데이터 파이프라인입니다.

가상의 데이터를 생성하고, PostgreSQL 데이터베이스에 적재한 뒤, 표준화된 계산 로직에 따라 베이스라인 및 감축량을 산정하며, 최종 결과를 Excel 보고서로 도출합니다.

## 2. 아키텍처 및 데이터 흐름

이 시스템은 독립적인 Python 스크립트들이 순차적으로 실행되는 배치 처리 아키텍처를 따릅니다. 데이터는 PostgreSQL 데이터베이스를 통해 각 단계 간에 전달됩니다.

```mermaid
graph TD
    A[시작: run_all.py 실행] --> B{DB 초기화?};
    B -- Yes --> C[00_edit_db.py: 테이블 재생성];
    B -- No --> D[01_insert_monthly_data.py: 데이터 생성 및 적재];
    C --> D;
    D --> E[02_calculate_baseline.py: 베이스라인 계산];
    E --> F[04_calculate_business_target.py: 감축량 계산 (단순 방식)];
    F --> G[05_co2_reduction_calc.py: 감축량 계산 (상세 방식, 덮어쓰기)];
    G --> H[03_display_baseline.py: 콘솔에 결과 출력];
    H --> I[06_Report.py: 최종 Excel 보고서 생성];
    I --> J[종료];
```

1. **DB 초기화 (선택)**: `run_all.py` 실행 시 사용자의 선택에 따라 `00_edit_db.py`가 DB 테이블을 초기화합니다.
2. **데이터 생성 및 적재**: `01_insert_monthly_data.py`가 가상의 차량 마스터 정보와 월별 운행 기록을 생성하여 DB에 저장합니다.
3. **베이스라인 계산**: `02_calculate_baseline.py`가 월별 운행 기록을 바탕으로 차량별 연평균 주행거리, 연평균 연료 소모량 등의 베이스라인 인자를 계산하여 DB에 저장합니다.
4. **감축량 계산 (단순)**: `04_calculate_business_target.py`가 단순 배출계수를 사용하여 잠정적인 감축량을 계산합니다.
5. **감축량 계산 (상세)**: `05_co2_reduction_calc.py`가 국가 표준(순발열량, 배출계수)에 따른 더 정확한 감축량을 계산하고, 이전 단계의 값을 덮어씁니다.
6. **결과 확인 및 보고서 생성**: `03_display_baseline.py`이 중간 결과를 콘솔에 출력하고, `06_Report.py`가 최종적으로 모든 데이터를 취합하여 `reports/` 폴더에 Excel 보고서를 생성합니다.

## 3. 스크립트 설명

| 스크립트 파일명                     | 역할                         | 주요 기능                                                                                                    |
| :---------------------------------- | :--------------------------- | :----------------------------------------------------------------------------------------------------------- |
| **`run_all.py`**            | **오케스트레이터**     | 모든 파이프라인 스크립트를 올바른 순서로 실행하고, 오류 발생 시 프로세스를 중단합니다.                       |
| `db_config.py`                    | 환경 설정                    | PostgreSQL 데이터베이스 연결 정보를 중앙에서 관리합니다.                                                     |
| `db_utils.py`                     | DB 유틸리티                  | DB 연결 및 종료 로직을 함수로 분리하여 코드 중복을 제거합니다.                                               |
| `00_edit_db.py`                   | DB 스키마 관리               | 프로젝트 관련 모든 테이블을 삭제(DROP)하고 재생성(CREATE)하여 DB를 초기 상태로 만듭니다.                     |
| `01_insert_monthly_data.py`       | 데이터 생성/적재             | 가상의 차량 마스터 및 월별 운행 기록 데이터를 생성하여 DB에 저장합니다.                                      |
| `02_calculate_baseline.py`        | 베이스라인 계산              | 월별 운행 기록을 바탕으로 연평균 주행거리, 연평균 연료량, 연비 등 베이스라인 인자를 계산합니다.              |
| `03_display_baseline.py`          | 중간 결과 조회               | 계산된 베이스라인 결과를 차량 정보와 함께 콘솔에 보기 쉽게 출력합니다.                                       |
| `04_calculate_business_target.py` | 감축량 계산 (단순)           | 단순 배출계수(kg/L)를 사용하여 CO2 감축량을 빠르게 계산합니다. (잠정치)                                      |
| `05_co2_reduction_calc.py`        | **감축량 계산 (상세)** | 국가 온실가스 인벤토리 지침에 따라 순발열량과 배출계수를 사용하여 CO2 감축량을 정확하게 계산합니다. (확정치) |
| `06_Report.py`                    | **최종 보고서 생성**   | DB의 모든 관련 데이터를 종합하여, 여러 시트로 구성된 상세 분석용 Excel 파일을 생성합니다.                    |

## 4. 데이터베이스 스키마

데이터는 4개의 주요 테이블로 정규화되어 관리됩니다.

* **`bus_vehicle_master`**: 차량의 고유 정보(차량번호, 업체명, 연식, 연료 타입 등)를 저장하는 마스터 테이블.
* **`bus_driving_records`**: 차량의 월별 운행 기록(주행거리, 연료 소모량 등)을 저장하는 트랜잭션 테이블.
* **`bus_baseline_parameters`**: `02`번 스크립트에서 계산된 차량별 베이스라인 인자를 저장하는 테이블.
* **`bus_emission_reductions`**: `04`, `05`번 스크립트에서 계산된 최종 CO2 감축량 정보를 저장하는 테이블.

상세한 스키마 정보는 `00_db_erd.md` 문서를 참고하십시오.

## 5. 시작하기

### 5.1. 사전 요구사항

* Python 3.8 이상
* PostgreSQL 12 이상

### 5.2. 환경 설정

1. **저장소 복제(Clone)**

   ```bash
   git clone <repository-url>
   cd <repository-directory>
   ```
2. **필요 라이브러리 설치**

   ```bash
   pip install pandas numpy psycopg2-binary openpyxl
   ```
3. **데이터베이스 연결 정보 수정**

   `db_config.py` 파일을 열어 자신의 PostgreSQL 환경에 맞게 `db_connection_params` 딕셔너리의 값을 수정합니다.

   ```python
   # db_config.py
   db_connection_params = {
       "host": "localhost",
       "dbname": "your_db_name",
       "user": "your_username",
       "password": "your_password",
       "port": "5432"
   }
   ```

### 5.3. 파이프라인 실행

터미널에서 아래의 마스터 스크립트를 실행합니다.

```bash
python run_all.py
```

스크립트가 실행되면 데이터베이스를 초기화할지 묻습니다.

* `y` 입력 시: 모든 테이블을 삭제하고 처음부터 파이프라인을 실행합니다.
* `N` 또는 다른 키 입력 시: 기존 데이터를 유지한 채 파이프라인을 실행합니다.

## 6. 결과물

파이프라인 실행이 성공적으로 완료되면, 프로젝트 루트 디렉토리에 `reports` 폴더가 생성되고 그 안에 다음과 같은 Excel 보고서 파일이 저장됩니다.

* `reports/bus_analysis_report_YYYYMMDD_HHMMSS.xlsx`

이 파일은 `종합 보고서`, `월별 운행기록`, `베이스라인 계산결과` 3개의 시트로 구성되어 전체 분석 과정을 상세히 검토할 수 있습니다.
